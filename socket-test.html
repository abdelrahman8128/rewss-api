<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socket.IO Connection Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      .status {
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
        font-weight: bold;
      }

      .status.connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.connecting {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .controls {
        margin: 20px 0;
      }

      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }

      button:hover {
        background-color: #0056b3;
      }

      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }

      .disconnect-btn {
        background-color: #dc3545;
      }

      .disconnect-btn:hover {
        background-color: #c82333;
      }

      .log {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
        margin-top: 20px;
      }

      .log-entry {
        margin: 5px 0;
        padding: 2px 0;
      }

      .log-entry.info {
        color: #007bff;
      }

      .log-entry.success {
        color: #28a745;
      }

      .log-entry.error {
        color: #dc3545;
      }

      .log-entry.warning {
        color: #ffc107;
      }

      .config {
        background-color: #e9ecef;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      }

      .config input {
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        margin: 5px;
        width: 200px;
      }

      .socket-id {
        font-family: "Courier New", monospace;
        background-color: #f8f9fa;
        padding: 5px;
        border-radius: 3px;
        margin: 10px 0;
      }

      .token-input {
        font-family: "Courier New", monospace;
        font-size: 12px;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        margin: 5px;
        width: 400px;
      }

      .token-input:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }

      .token-status {
        margin-top: 10px;
        font-size: 12px;
        padding: 5px;
        border-radius: 3px;
        background-color: #f8f9fa;
      }

      .config-row {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
      }

      .config-row label {
        font-weight: bold;
        min-width: 120px;
      }

      .message {
        margin: 10px 0;
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 70%;
        word-wrap: break-word;
      }

      .message.sent {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
      }

      .message.received {
        background-color: #e9ecef;
        color: #333;
        margin-right: auto;
      }

      .message-info {
        font-size: 12px;
        opacity: 0.7;
        margin-top: 5px;
      }

      .message.sent .message-info {
        text-align: right;
      }

      .typing-dots {
        display: inline-block;
        animation: typing 1.5s infinite;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          opacity: 0.3;
        }
        30% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üí¨ Real-Time Chat</h1>
      <div
        style="
          background-color: #e7f3ff;
          border: 1px solid #b3d9ff;
          border-radius: 5px;
          padding: 15px;
          margin-bottom: 20px;
        "
      >
        <strong>üìã Instructions:</strong>
        <ol style="margin: 10px 0; padding-left: 20px">
          <li>Enter your server URL (default: http://localhost:8000)</li>
          <li>Provide a valid JWT authentication token</li>
          <li>Enter the User ID you want to chat with</li>
          <li>Click "Connect" to establish authenticated socket connection</li>
          <li>Start chatting in real-time!</li>
          <li>
            <strong>File Upload:</strong> Select files to upload - they will be
            automatically saved to S3
          </li>
        </ol>
        <div
          style="
            background-color: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
          "
        >
          <strong>üìÅ File Upload Features:</strong>
          <ul style="margin: 5px 0; padding-left: 20px">
            <li>Images, videos, audio, and documents are supported</li>
            <li>Files are automatically uploaded to S3 storage</li>
            <li>File metadata (name, size, type) is stored with messages</li>
            <li>Images and videos show previews in the chat</li>
            <li>Files are organized by chat ID in S3</li>
          </ul>
        </div>
      </div>

      <div class="config">
        <h3>Configuration</h3>
        <div class="config-row">
          <label for="serverUrl">Server URL:</label>
          <input
            type="text"
            id="serverUrl"
            value="http://localhost:8000"
            placeholder="http://localhost:8000"
          />
          <button onclick="updateServerUrl()">Update URL</button>
        </div>
        <div class="config-row">
          <label for="authToken">Authentication Token:</label>
          <input
            type="text"
            id="authToken"
            class="token-input"
            placeholder="Enter JWT token for authentication"
          />
          <button onclick="validateToken()">Validate Token</button>
          <button onclick="generateTestToken()">Generate Test Token</button>
        </div>
        <div class="config-row">
          <label for="chatWithUserId">Chat with User ID:</label>
          <input
            type="text"
            id="chatWithUserId"
            placeholder="Enter the User ID you want to chat with"
            style="width: 300px"
          />
        </div>
        <div class="config-row">
          <label for="messageIdInput">Message ID (for actions):</label>
          <input
            type="text"
            id="messageIdInput"
            placeholder="Enter message ID for reactions/edits"
            style="width: 300px"
          />
        </div>
        <div class="config-row">
          <label for="emojiInput">Emoji for Reaction:</label>
          <input
            type="text"
            id="emojiInput"
            placeholder="Enter emoji (e.g., üòÄ, üëç)"
            style="width: 150px"
            value="üòÄ"
          />
        </div>
        <div id="tokenStatus" class="token-status"></div>
      </div>

      <div id="status" class="status disconnected">‚ùå Disconnected</div>

      <div id="socketId" class="socket-id" style="display: none">
        Socket ID: <span id="socketIdValue"></span>
      </div>

      <div class="controls">
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>
          Disconnect
        </button>
        <button onclick="clearChat()">Clear Chat</button>
        <button onclick="loadMessages()" id="loadBtn" disabled>
          Load Messages
        </button>
        <button onclick="getRoomParticipants()" id="participantsBtn" disabled>
          Get Room Participants
        </button>
        <button onclick="toggleReconnection()" id="reconnectBtn">
          Disable Auto-Reconnect
        </button>
      </div>

      <!-- Chat Interface -->
      <div id="chatInterface" style="display: none; margin-top: 20px">
        <div
          style="
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
          "
        >
          <h3 style="margin-top: 0; color: #333">
            Chat with <span id="chatPartnerName">User</span>
            <span
              id="unreadCount"
              style="
                display: none;
                background-color: #dc3545;
                color: white;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 12px;
                margin-left: 10px;
              "
              >0</span
            >
          </h3>

          <!-- Chat Messages Area -->
          <div
            id="chatMessages"
            style="
              height: 400px;
              overflow-y: auto;
              border: 1px solid #ddd;
              border-radius: 5px;
              padding: 15px;
              margin-bottom: 15px;
              background-color: #f9f9f9;
            "
          >
            <div style="text-align: center; color: #666; font-style: italic">
              Start typing to begin the conversation...
            </div>
          </div>

          <!-- Message Input Area -->
          <div style="display: flex; gap: 10px; margin-bottom: 10px">
            <input
              type="text"
              id="messageInput"
              placeholder="Type your message here..."
              style="
                flex: 1;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
              "
              onkeypress="handleKeyPress(event)"
            />
            <button
              onclick="sendMessage()"
              id="sendBtn"
              disabled
              style="padding: 10px 20px"
            >
              Send
            </button>
          </div>

          <!-- File Upload Area -->
          <div
            style="
              display: flex;
              gap: 10px;
              margin-bottom: 10px;
              align-items: center;
            "
          >
            <input
              type="file"
              id="fileInput"
              accept="*/*"
              style="flex: 1; padding: 5px"
              onchange="handleFileSelect(event)"
            />
            <button
              onclick="sendFile()"
              id="sendFileBtn"
              disabled
              style="
                padding: 10px 20px;
                background-color: #28a745;
                color: white;
                border: none;
                border-radius: 5px;
              "
            >
              Send File
            </button>
            <button
              onclick="clearFile()"
              id="clearFileBtn"
              disabled
              style="
                padding: 10px 20px;
                background-color: #dc3545;
                color: white;
                border: none;
                border-radius: 5px;
              "
            >
              Clear
            </button>
          </div>

          <!-- File Preview -->
          <div id="filePreview" style="margin-bottom: 10px; display: none">
            <div
              id="previewContent"
              style="
                border: 1px solid #ddd;
                padding: 10px;
                border-radius: 5px;
                background-color: #f8f9fa;
              "
            >
              <!-- File preview will be shown here -->
            </div>
          </div>

          <!-- Message Actions -->
          <div
            style="
              display: flex;
              gap: 5px;
              margin-bottom: 10px;
              flex-wrap: wrap;
            "
          >
            <button
              onclick="addReaction()"
              id="reactionBtn"
              disabled
              style="padding: 5px 10px; font-size: 12px"
            >
              Add Reaction
            </button>
            <button
              onclick="editMessage()"
              id="editBtn"
              disabled
              style="padding: 5px 10px; font-size: 12px"
            >
              Edit Message
            </button>
            <button
              onclick="deleteMessage()"
              id="deleteBtn"
              disabled
              style="padding: 5px 10px; font-size: 12px"
            >
              Delete Message
            </button>
            <button
              onclick="markAsRead()"
              id="readBtn"
              disabled
              style="padding: 5px 10px; font-size: 12px"
            >
              Mark as Read
            </button>
          </div>

          <!-- Typing Indicator -->
          <div
            id="typingIndicator"
            style="
              margin-top: 10px;
              color: #666;
              font-style: italic;
              font-size: 14px;
              display: none;
            "
          >
            <span id="typingText"></span>
          </div>
        </div>
      </div>

      <div class="log" id="log">
        <div class="log-entry info">
          Ready to connect to Socket.IO server...
        </div>
      </div>
    </div>
    <script>
      let socket = null;
      let serverUrl = "http://localhost:8000";
      let autoReconnect = true;
      let currentUserId = null;
      let chatPartnerId = null;
      let typingTimeout = null;
      let currentChatId = null;
      let selectedMessageId = null;
      let selectedFile = null;

      function log(message, type = "info") {
        const logDiv = document.getElementById("log");
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function updateStatus(status, message) {
        const statusDiv = document.getElementById("status");
        statusDiv.className = `status ${status}`;
        statusDiv.textContent = message;
      }

      function updateSocketId(socketId) {
        const socketIdDiv = document.getElementById("socketId");
        const socketIdValue = document.getElementById("socketIdValue");

        if (socketId) {
          socketIdValue.textContent = socketId;
          socketIdDiv.style.display = "block";
        } else {
          socketIdDiv.style.display = "none";
        }
      }

      function updateButtons(connected) {
        document.getElementById("connectBtn").disabled = connected;
        document.getElementById("disconnectBtn").disabled = !connected;
        document.getElementById("sendBtn").disabled = !connected;
        document.getElementById("loadBtn").disabled = !connected;
        const safeDisable = (id) => {
          const el = document.getElementById(id);
          if (el) el.disabled = !connected;
        };
        safeDisable("reactionBtn");
        safeDisable("editBtn");
        safeDisable("deleteBtn");
        safeDisable("readBtn");
        safeDisable("sendFileBtn");
        safeDisable("participantsBtn");

        // Show/hide chat interface
        const chatInterface = document.getElementById("chatInterface");
        chatInterface.style.display = connected ? "block" : "none";
      }

      function updateServerUrl() {
        serverUrl = document.getElementById("serverUrl").value;
        log(`Server URL updated to: ${serverUrl}`, "info");
      }

      function validateToken() {
        const token = document.getElementById("authToken").value;
        const tokenStatus = document.getElementById("tokenStatus");

        if (!token) {
          tokenStatus.innerHTML =
            '<span style="color: #dc3545;">‚ùå No token provided</span>';
          return false;
        }

        try {
          const parts = token.split(".");
          if (parts.length !== 3) throw new Error("Invalid JWT format");

          const header = JSON.parse(atob(parts[0]));
          const payload = JSON.parse(atob(parts[1]));
          const now = Math.floor(Date.now() / 1000);

          if (payload.exp && payload.exp < now) {
            tokenStatus.innerHTML =
              '<span style="color: #dc3545;">‚ùå Token expired</span>';
            return false;
          }

          tokenStatus.innerHTML = `<span style="color: #28a745;">‚úÖ Token valid (expires: ${
            payload.exp
              ? new Date(payload.exp * 1000).toLocaleString()
              : "No expiration"
          })</span>`;
          log(
            `Token validated successfully. User: ${
              payload.id || payload.sub || payload.userId || "Unknown"
            }`,
            "success"
          );
          return true;
        } catch (error) {
          tokenStatus.innerHTML = `<span style="color: #dc3545;">‚ùå Invalid token: ${error.message}</span>`;
          log(`Token validation failed: ${error.message}`, "error");
          return false;
        }
      }

      function connect() {
        if (socket && socket.connected) {
          log("Already connected!", "warning");
          return;
        }

        if (socket) {
          socket.disconnect();
          socket = null;
        }

        log(`Attempting to connect to ${serverUrl}...`, "info");
        updateStatus("connecting", "üîÑ Connecting...");

        const token = document.getElementById("authToken").value;
        const chatWithUserId = document.getElementById("chatWithUserId").value;

        if (!token) {
          log("‚ùå No authentication token provided!", "error");
          updateStatus("disconnected", "‚ùå No Token");
          return;
        }

        if (!chatWithUserId) {
          log("‚ùå Please enter a User ID to chat with!", "error");
          updateStatus("disconnected", "‚ùå No Chat Partner");
          return;
        }

        chatPartnerId = chatWithUserId;

        socket = io(`${serverUrl}/chat`, {
          transports: ["websocket", "polling"],
          timeout: 20000,
          forceNew: true,
          reconnection: autoReconnect,
          reconnectionAttempts: autoReconnect ? 3 : 0,
          reconnectionDelay: 1000,
          maxReconnectionAttempts: autoReconnect ? 3 : 0,
          auth: { token },
        });

        // ====== Global client-side logging wrappers ======
        try {
          // Log all received events
          socket.onAny((event, ...args) => {
            try {
              const firstArg = args?.[0];
              const summary =
                firstArg && typeof firstArg === "object"
                  ? Object.keys(firstArg).join(",")
                  : typeof firstArg;
              log(`[recv] ${event} (${summary})`, "info");
            } catch (e) {
              log(`[recv] ${event}`, "info");
            }
          });

          // Log all emits
          const originalEmit = socket.emit.bind(socket);
          socket.emit = (event, ...args) => {
            try {
              const firstArg = args?.[0];
              const summary =
                firstArg && typeof firstArg === "object"
                  ? Object.keys(firstArg).join(",")
                  : typeof firstArg;
              log(`[emit] ${event} (${summary})`, "info");
            } catch (e) {
              log(`[emit] ${event}`, "info");
            }
            return originalEmit(event, ...args);
          };
        } catch (e) {
          // no-op
        }

        socket.on("connect", () => {
          log(`‚úÖ Connected successfully! Socket ID: ${socket.id}`, "success");
          updateStatus("connected", "‚úÖ Connected");
          updateSocketId(socket.id);
          updateButtons(true);

          document.getElementById("chatPartnerName").textContent =
            chatPartnerId;

          try {
            const payload = JSON.parse(atob(token.split(".")[1]));
            currentUserId = payload.id || payload.sub || payload.userId;
            log(`üë§ Current user ID: ${currentUserId}`, "info");
          } catch {
            currentUserId = "unknown";
          }

          socket.emit("joinRoom", { receiverId: chatPartnerId });
          log(`üè† Joined chat room with ${chatPartnerId}`, "info");
        });

        socket.on("disconnect", (reason) => {
          log(`‚ùå Disconnected: ${reason}`, "error");
          updateStatus("disconnected", "‚ùå Disconnected");
          updateSocketId(null);
          updateButtons(false);
        });

        socket.on("connect_error", (error) => {
          log(`‚ùå Connection error: ${error.message}`, "error");
          updateStatus("disconnected", "‚ùå Connection Failed");
          updateButtons(false);
        });

        // Heartbeat
        setInterval(() => {
          if (socket && socket.connected) {
            socket.emit("ping", { timestamp: Date.now() });
          }
        }, 30000);

        // ====== Chat Events ======
        socket.on("message", (data) => {
          log(`üí¨ Message received: ${data.message}`, "info");

          // ŸÑŸà ÿØŸä ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿ®ÿ™ÿßÿπÿ™Ÿä ‚Üí ÿ≠ÿØÿ´ ÿßŸÑŸÄ status ŸÖŸÜ sending ŸÑŸÄ sent
          if (data.senderId === currentUserId) {
            updateMessageStatus(data.messageId, "sent", currentUserId);
          }

          addMessage(
            data.message,
            data.senderId,
            data.senderId === currentUserId,
            data
          );
        });

        socket.on("messageDelivered", (data) => {
          log(`üì¨ Delivered: ${data.messageId} to ${data.deliveredTo}`, "info");
          updateMessageStatus(data.messageId, "delivered", data.deliveredTo);
        });

        socket.on("messageRead", (data) => {
          log(`üìñ Read: ${data.messageId} by ${data.readBy}`, "info");
          updateMessageStatus(
            data.messageId,
            "read",
            data.readBy,
            data.readByCount || 1
          );
        });

        socket.on("messagesResponse", (data) => {
          currentChatId = data.chatId || currentChatId;
          displayMessages(data.messages);
        });

        socket.on("pong", (data) => {
          const latency = Date.now() - data.timestamp;
          log(`üíì Heartbeat (${latency}ms)`, "info");
        });
      }

      function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value.trim();
        if (!message) return;

        if (socket && socket.connected) {
          socket.emit("sendMessage", {
            receiverId: chatPartnerId,
            message,
          });

          const tempMessageData = {
            messageId: Math.random().toString(36).substr(2, 9),
            timestamp: new Date().toISOString(),
            messageType: "text",
            status: "sending",
            readBy: [],
          };

          addMessage(message, "You", true, tempMessageData);
          messageInput.value = "";
        }
      }

      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        } else if (socket && socket.connected) {
          socket.emit("typing", { receiverId: chatPartnerId });
        }
      }

      function addMessage(text, sender, isSent, messageData = null) {
        const chatMessages = document.getElementById("chatMessages");

        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${isSent ? "sent" : "received"}`;
        if (messageData) {
          messageDiv.setAttribute("data-message-id", messageData.messageId);
        }

        const timestamp = messageData
          ? new Date(messageData.timestamp).toLocaleTimeString()
          : new Date().toLocaleTimeString();

        let readStatus = "";
        if (isSent && messageData) {
          if (messageData.readBy && messageData.readBy.length > 0) {
            readStatus = ` ‚Ä¢ ‚úÖ Read by ${messageData.readBy.length}`;
          } else {
            readStatus = ` ‚Ä¢ üì§ ${messageData.status}`;
          }
        }

        messageDiv.innerHTML = `
          <div class="message-content">${text}</div>
          <div class="message-info">
            ${sender} ‚Ä¢ ${timestamp}${readStatus}
          </div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function loadMessages() {
        if (socket && socket.connected && currentChatId) {
          socket.emit("getMessages", {
            chatId: currentChatId,
            page: 1,
            limit: 50,
          });
          log("üìã Loading messages...", "info");
        } else {
          log("Not connected or no chat selected!", "error");
        }
      }

      function getRoomParticipants() {
        if (socket && socket.connected) {
          socket.emit("getRoomParticipants");
          log("üë• Getting room participants...", "info");
        } else {
          log("Not connected to server!", "error");
        }
      }

      function addReaction() {
        const messageId = document.getElementById("messageIdInput").value;
        const emoji = document.getElementById("emojiInput").value;
        if (!messageId) return log("Please enter a message ID", "error");
        if (socket && socket.connected) {
          socket.emit("addReaction", { messageId, emoji });
          log(`üòä Adding reaction ${emoji} to message ${messageId}`, "info");
        }
      }

      function editMessage() {
        const messageId = document.getElementById("messageIdInput").value;
        const newMessage = prompt("Enter new message:", "");
        if (!messageId || !newMessage) return;
        if (socket && socket.connected) {
          socket.emit("editMessage", { messageId, newMessage });
          log(`‚úèÔ∏è Editing message ${messageId}`, "info");
        }
      }

      function deleteMessage() {
        const messageId = document.getElementById("messageIdInput").value;
        if (!messageId) return log("Please enter a message ID", "error");
        if (confirm("Are you sure you want to delete this message?")) {
          if (socket && socket.connected) {
            socket.emit("deleteMessage", { messageId });
            log(`üóëÔ∏è Deleting message ${messageId}`, "info");
          }
        }
      }

      function markAsRead() {
        const messageId = document.getElementById("messageIdInput").value;
        if (!messageId) return log("Please enter a message ID", "error");
        if (socket && socket.connected) {
          socket.emit("markAsRead", { messageId });
          log(`üìñ Marking message ${messageId} as read`, "info");
        }
      }

      function updateMessageStatus(
        messageId,
        status,
        userId,
        readByCount = null
      ) {
        const messageElement = document.querySelector(
          `[data-message-id="${messageId}"]`
        );
        if (messageElement) {
          const info = messageElement.querySelector(".message-info");
          if (!info) return;

          if (status === "delivered") {
            info.innerHTML += ` ‚Ä¢ üì¨ Delivered`;
          } else if (status === "read") {
            info.innerHTML = info.innerHTML.replace(/üì§.*/, "");
            info.innerHTML += ` ‚Ä¢ ‚úÖ Read by ${readByCount || 1}`;
          } else if (status === "sent") {
            info.innerHTML = info.innerHTML.replace(/üì§.*/, "");
            info.innerHTML += ` ‚Ä¢ üì§ Sent`;
          }
        }
      }

      function displayMessages(messages) {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML = "";
        if (messages.length === 0) return;

        const sorted = messages.sort(
          (a, b) => new Date(a.timestamp) - new Date(b.timestamp)
        );
        sorted.forEach((msg) => {
          const isSent = msg.senderId === currentUserId;
          addMessage(msg.message, isSent ? "You" : msg.senderId, isSent, msg);
        });
      }

      // File handling
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        selectedFile = file;
        showFilePreview(file);
        const sendBtn = document.getElementById("sendFileBtn");
        const clearBtn = document.getElementById("clearFileBtn");
        if (sendBtn) sendBtn.disabled = false;
        if (clearBtn) clearBtn.disabled = false;
        log(`üìÅ File selected: ${file.name}`, "info");
      }

      function showFilePreview(file) {
        const preview = document.getElementById("filePreview");
        const content = document.getElementById("previewContent");
        if (!preview || !content) return;
        preview.style.display = "block";
        let html = `<strong>File:</strong> ${file.name}<br>`;
        html += `<strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(
          2
        )} MB<br>`;
        html += `<strong>Type:</strong> ${file.type}`;
        content.innerHTML = html;
      }

      function clearFile() {
        selectedFile = null;
        const input = document.getElementById("fileInput");
        const preview = document.getElementById("filePreview");
        const sendBtn = document.getElementById("sendFileBtn");
        const clearBtn = document.getElementById("clearFileBtn");
        if (input) input.value = "";
        if (preview) preview.style.display = "none";
        if (sendBtn) sendBtn.disabled = true;
        if (clearBtn) clearBtn.disabled = true;
        log("üóëÔ∏è File cleared", "info");
      }

      function sendFile() {
        if (!selectedFile || !socket || !socket.connected) {
          return log("No file selected or not connected!", "error");
        }
        const file = selectedFile;
        const messageType = /^image\//.test(file.type)
          ? "image"
          : /^audio\//.test(file.type)
          ? "audio"
          : /^video\//.test(file.type)
          ? "video"
          : "file";

        const reader = new FileReader();
        reader.onload = function (e) {
          const base64String = e.target.result.split(",")[1];
          const fileData = {
            buffer: base64String,
            originalname: file.name,
            mimetype: file.type,
            size: file.size,
          };
          const meta = {
            fileName: file.name,
            fileSize: file.size,
            mimeType: file.type,
          };
          addMessage(`üìé ${file.name}`, "You", true, {
            messageId: Math.random().toString(36).substr(2, 9),
            timestamp: new Date().toISOString(),
            messageType,
            status: "sending",
            metadata: meta,
          });
          socket.emit("sendMessage", {
            receiverId: chatPartnerId,
            message: `üìé ${file.name}`,
            messageType,
            file: fileData,
            metadata: meta,
          });
          clearFile();
        };
        reader.readAsDataURL(file);
      }

      function disconnect() {
        if (socket) {
          socket.disconnect();
          socket = null;
        }
      }
    </script>
  </body>
</html>
