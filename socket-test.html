<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socket.IO Connection Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      .status {
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
        font-weight: bold;
      }

      .status.connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.connecting {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .controls {
        margin: 20px 0;
      }

      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }

      button:hover {
        background-color: #0056b3;
      }

      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }

      .disconnect-btn {
        background-color: #dc3545;
      }

      .disconnect-btn:hover {
        background-color: #c82333;
      }

      .log {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
        margin-top: 20px;
      }

      .log-entry {
        margin: 5px 0;
        padding: 2px 0;
      }

      .log-entry.info {
        color: #007bff;
      }

      .log-entry.success {
        color: #28a745;
      }

      .log-entry.error {
        color: #dc3545;
      }

      .log-entry.warning {
        color: #ffc107;
      }

      .config {
        background-color: #e9ecef;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      }

      .config input {
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        margin: 5px;
        width: 200px;
      }

      .socket-id {
        font-family: "Courier New", monospace;
        background-color: #f8f9fa;
        padding: 5px;
        border-radius: 3px;
        margin: 10px 0;
      }

      .token-input {
        font-family: "Courier New", monospace;
        font-size: 12px;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        margin: 5px;
        width: 400px;
      }

      .token-input:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }

      .token-status {
        margin-top: 10px;
        font-size: 12px;
        padding: 5px;
        border-radius: 3px;
        background-color: #f8f9fa;
      }

      .config-row {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
      }

      .config-row label {
        font-weight: bold;
        min-width: 120px;
      }

      .message {
        margin: 10px 0;
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 70%;
        word-wrap: break-word;
      }

      .message.sent {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
      }

      .message.received {
        background-color: #e9ecef;
        color: #333;
        margin-right: auto;
      }

      .message-info {
        font-size: 12px;
        opacity: 0.7;
        margin-top: 5px;
      }

      .message.sent .message-info {
        text-align: right;
      }

      .typing-dots {
        display: inline-block;
        animation: typing 1.5s infinite;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          opacity: 0.3;
        }
        30% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üí¨ Real-Time Chat</h1>
      <div
        style="
          background-color: #e7f3ff;
          border: 1px solid #b3d9ff;
          border-radius: 5px;
          padding: 15px;
          margin-bottom: 20px;
        "
      >
        <strong>üìã Instructions:</strong>
        <ol style="margin: 10px 0; padding-left: 20px">
          <li>Enter your server URL (default: http://localhost:8000)</li>
          <li>Provide a valid JWT authentication token</li>
          <li>Enter the User ID you want to chat with</li>
          <li>Click "Connect" to establish authenticated socket connection</li>
          <li>Start chatting in real-time!</li>
        </ol>
      </div>

      <div class="config">
        <h3>Configuration</h3>
        <div class="config-row">
          <label for="serverUrl">Server URL:</label>
          <input
            type="text"
            id="serverUrl"
            value="http://localhost:8000"
            placeholder="http://localhost:8000"
          />
          <button onclick="updateServerUrl()">Update URL</button>
        </div>
        <div class="config-row">
          <label for="authToken">Authentication Token:</label>
          <input
            type="text"
            id="authToken"
            class="token-input"
            placeholder="Enter JWT token for authentication"
          />
          <button onclick="validateToken()">Validate Token</button>
          <button onclick="generateTestToken()">Generate Test Token</button>
        </div>
        <div class="config-row">
          <label for="chatWithUserId">Chat with User ID:</label>
          <input
            type="text"
            id="chatWithUserId"
            placeholder="Enter the User ID you want to chat with"
            style="width: 300px"
          />
        </div>
        <div class="config-row">
          <label for="messageIdInput">Message ID (for actions):</label>
          <input
            type="text"
            id="messageIdInput"
            placeholder="Enter message ID for reactions/edits"
            style="width: 300px"
          />
        </div>
        <div class="config-row">
          <label for="emojiInput">Emoji for Reaction:</label>
          <input
            type="text"
            id="emojiInput"
            placeholder="Enter emoji (e.g., üòÄ, üëç)"
            style="width: 150px"
            value="üòÄ"
          />
        </div>
        <div id="tokenStatus" class="token-status"></div>
      </div>

      <div id="status" class="status disconnected">‚ùå Disconnected</div>

      <div id="socketId" class="socket-id" style="display: none">
        Socket ID: <span id="socketIdValue"></span>
      </div>

      <div class="controls">
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>
          Disconnect
        </button>
        <button onclick="clearChat()">Clear Chat</button>
        <button onclick="loadMessages()" id="loadBtn" disabled>
          Load Messages
        </button>
        <button onclick="toggleReconnection()" id="reconnectBtn">
          Disable Auto-Reconnect
        </button>
      </div>

      <!-- Chat Interface -->
      <div id="chatInterface" style="display: none; margin-top: 20px">
        <div
          style="
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
          "
        >
          <h3 style="margin-top: 0; color: #333">
            Chat with <span id="chatPartnerName">User</span>
          </h3>

          <!-- Chat Messages Area -->
          <div
            id="chatMessages"
            style="
              height: 400px;
              overflow-y: auto;
              border: 1px solid #ddd;
              border-radius: 5px;
              padding: 15px;
              margin-bottom: 15px;
              background-color: #f9f9f9;
            "
          >
            <div style="text-align: center; color: #666; font-style: italic">
              Start typing to begin the conversation...
            </div>
          </div>

          <!-- Message Input Area -->
          <div style="display: flex; gap: 10px; margin-bottom: 10px">
            <input
              type="text"
              id="messageInput"
              placeholder="Type your message here..."
              style="
                flex: 1;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
              "
              onkeypress="handleKeyPress(event)"
            />
            <button
              onclick="sendMessage()"
              id="sendBtn"
              disabled
              style="padding: 10px 20px"
            >
              Send
            </button>
          </div>

          <!-- File Upload Area -->
          <div
            style="
              display: flex;
              gap: 10px;
              margin-bottom: 10px;
              align-items: center;
            "
          >
            <input
              type="file"
              id="fileInput"
              accept="image/*,audio/*,video/*"
              style="flex: 1; padding: 5px"
              onchange="handleFileSelect(event)"
            />
            <button
              onclick="sendFile()"
              id="sendFileBtn"
              disabled
              style="
                padding: 10px 20px;
                background-color: #28a745;
                color: white;
                border: none;
                border-radius: 5px;
              "
            >
              Send File
            </button>
            <button
              onclick="clearFile()"
              id="clearFileBtn"
              disabled
              style="
                padding: 10px 20px;
                background-color: #dc3545;
                color: white;
                border: none;
                border-radius: 5px;
              "
            >
              Clear
            </button>
          </div>

          <!-- File Preview -->
          <div id="filePreview" style="margin-bottom: 10px; display: none">
            <div
              id="previewContent"
              style="
                border: 1px solid #ddd;
                padding: 10px;
                border-radius: 5px;
                background-color: #f8f9fa;
              "
            >
              <!-- File preview will be shown here -->
            </div>
          </div>

          <!-- Message Actions -->
          <div
            style="
              display: flex;
              gap: 5px;
              margin-bottom: 10px;
              flex-wrap: wrap;
            "
          >
            <button
              onclick="addReaction()"
              id="reactionBtn"
              disabled
              style="padding: 5px 10px; font-size: 12px"
            >
              Add Reaction
            </button>
            <button
              onclick="editMessage()"
              id="editBtn"
              disabled
              style="padding: 5px 10px; font-size: 12px"
            >
              Edit Message
            </button>
            <button
              onclick="deleteMessage()"
              id="deleteBtn"
              disabled
              style="padding: 5px 10px; font-size: 12px"
            >
              Delete Message
            </button>
            <button
              onclick="markAsRead()"
              id="readBtn"
              disabled
              style="padding: 5px 10px; font-size: 12px"
            >
              Mark as Read
            </button>
          </div>

          <!-- Typing Indicator -->
          <div
            id="typingIndicator"
            style="
              margin-top: 10px;
              color: #666;
              font-style: italic;
              font-size: 14px;
              display: none;
            "
          >
            <span id="typingText"></span>
          </div>
        </div>
      </div>

      <div class="log" id="log">
        <div class="log-entry info">
          Ready to connect to Socket.IO server...
        </div>
      </div>
    </div>

    <script>
      let socket = null;
      let serverUrl = "http://localhost:8000";
      let autoReconnect = true;
      let currentUserId = null;
      let chatPartnerId = null;
      let typingTimeout = null;
      let currentChatId = null;
      let selectedMessageId = null;
      let selectedFile = null;

      function log(message, type = "info") {
        const logDiv = document.getElementById("log");
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function updateStatus(status, message) {
        const statusDiv = document.getElementById("status");
        statusDiv.className = `status ${status}`;
        statusDiv.textContent = message;
      }

      function updateSocketId(socketId) {
        const socketIdDiv = document.getElementById("socketId");
        const socketIdValue = document.getElementById("socketIdValue");

        if (socketId) {
          socketIdValue.textContent = socketId;
          socketIdDiv.style.display = "block";
        } else {
          socketIdDiv.style.display = "none";
        }
      }

      function updateButtons(connected) {
        document.getElementById("connectBtn").disabled = connected;
        document.getElementById("disconnectBtn").disabled = !connected;
        document.getElementById("sendBtn").disabled = !connected;
        document.getElementById("loadBtn").disabled = !connected;
        document.getElementById("reactionBtn").disabled = !connected;
        document.getElementById("editBtn").disabled = !connected;
        document.getElementById("deleteBtn").disabled = !connected;
        document.getElementById("readBtn").disabled = !connected;
        document.getElementById("sendFileBtn").disabled = !connected;

        // Show/hide chat interface
        const chatInterface = document.getElementById("chatInterface");
        chatInterface.style.display = connected ? "block" : "none";
      }

      function updateServerUrl() {
        serverUrl = document.getElementById("serverUrl").value;
        log(`Server URL updated to: ${serverUrl}`, "info");
      }

      function validateToken() {
        const token = document.getElementById("authToken").value;
        const tokenStatus = document.getElementById("tokenStatus");

        if (!token) {
          tokenStatus.innerHTML =
            '<span style="color: #dc3545;">‚ùå No token provided</span>';
          return false;
        }

        try {
          // Basic JWT structure validation
          const parts = token.split(".");
          if (parts.length !== 3) {
            throw new Error("Invalid JWT format");
          }

          // Decode header and payload (without verification)
          const header = JSON.parse(atob(parts[0]));
          const payload = JSON.parse(atob(parts[1]));

          // Check if token is expired
          const now = Math.floor(Date.now() / 1000);
          if (payload.exp && payload.exp < now) {
            tokenStatus.innerHTML =
              '<span style="color: #dc3545;">‚ùå Token expired</span>';
            return false;
          }

          tokenStatus.innerHTML = `<span style="color: #28a745;">‚úÖ Token valid (expires: ${
            payload.exp
              ? new Date(payload.exp * 1000).toLocaleString()
              : "No expiration"
          })</span>`;
          log(
            `Token validated successfully. User: ${
              payload.id || payload.sub || payload.userId || "Unknown"
            }`,
            "success"
          );
          return true;
        } catch (error) {
          tokenStatus.innerHTML = `<span style="color: #dc3545;">‚ùå Invalid token: ${error.message}</span>`;
          log(`Token validation failed: ${error.message}`, "error");
          return false;
        }
      }

      function generateTestToken() {
        // This is a simple test token generator - in production, tokens should come from your auth server
        const testPayload = {
          id: "test_user_123",
          sub: "test_user_123",
          userId: "test_user_123",
          email: "test@example.com",
          iat: Math.floor(Date.now() / 1000),
          exp: Math.floor(Date.now() / 1000) + 60 * 60, // 1 hour from now
        };

        // Create a simple test token (this won't work with real JWT verification, but good for testing structure)
        const header = btoa(JSON.stringify({ alg: "HS256", typ: "JWT" }));
        const payload = btoa(JSON.stringify(testPayload));
        const signature = "test_signature"; // This is just for testing structure

        const testToken = `${header}.${payload}.${signature}`;
        document.getElementById("authToken").value = testToken;

        log(
          "Generated test token (Note: This won't work with real JWT verification)",
          "warning"
        );
        log(
          "For real testing, use a token from your authentication server",
          "info"
        );

        validateToken();
      }

      function connect() {
        if (socket && socket.connected) {
          log("Already connected!", "warning");
          return;
        }

        // Disconnect existing socket if any
        if (socket) {
          socket.disconnect();
          socket = null;
        }

        log(`Attempting to connect to ${serverUrl}...`, "info");
        updateStatus("connecting", "üîÑ Connecting...");

        const token = document.getElementById("authToken").value;
        const chatWithUserId = document.getElementById("chatWithUserId").value;

        if (!token) {
          log("‚ùå No authentication token provided!", "error");
          updateStatus("disconnected", "‚ùå No Token");
          return;
        }

        if (!chatWithUserId) {
          log("‚ùå Please enter a User ID to chat with!", "error");
          updateStatus("disconnected", "‚ùå No Chat Partner");
          return;
        }

        chatPartnerId = chatWithUserId;

        socket = io(`${serverUrl}/chat`, {
          transports: ["websocket", "polling"],
          timeout: 20000,
          forceNew: true,
          reconnection: autoReconnect,
          reconnectionAttempts: autoReconnect ? 3 : 0,
          reconnectionDelay: 1000,
          maxReconnectionAttempts: autoReconnect ? 3 : 0,
          auth: {
            token: token,
          },
        });

        // Connection events
        socket.on("connect", () => {
          log(`‚úÖ Connected successfully! Socket ID: ${socket.id}`, "success");
          updateStatus("connected", "‚úÖ Connected");
          updateSocketId(socket.id);
          updateButtons(true);

          // Update chat partner name
          document.getElementById("chatPartnerName").textContent =
            chatPartnerId;

          // Join the chat room
          socket.emit("joinRoom", { receiverId: chatPartnerId });
          log(`üè† Joined chat room with ${chatPartnerId}`, "info");

          // Store chat ID for message loading
          currentChatId = "temp_chat_id"; // This would be the actual chat ID from the server
        });

        socket.on("disconnect", (reason) => {
          log(`‚ùå Disconnected: ${reason}`, "error");
          updateStatus("disconnected", "‚ùå Disconnected");
          updateSocketId(null);
          updateButtons(false);
        });

        socket.on("connect_error", (error) => {
          log(`‚ùå Connection error: ${error.message}`, "error");

          // Check if it's an authentication error
          if (
            error.message.includes("Unauthorized") ||
            error.message.includes("token")
          ) {
            log("üîê Authentication failed - check your token", "error");
            updateStatus("disconnected", "‚ùå Auth Failed");
          } else {
            updateStatus("disconnected", "‚ùå Connection Failed");
          }

          updateButtons(false);
        });

        socket.on("reconnect", (attemptNumber) => {
          log(`üîÑ Reconnected after ${attemptNumber} attempts`, "success");
          updateStatus("connected", "‚úÖ Reconnected");
          updateSocketId(socket.id);
          updateButtons(true);
        });

        socket.on("reconnect_error", (error) => {
          log(`‚ùå Reconnection error: ${error.message}`, "error");
        });

        socket.on("reconnect_failed", () => {
          log("‚ùå Reconnection failed after all attempts", "error");
          updateStatus("disconnected", "‚ùå Reconnection Failed");
          updateButtons(false);
        });

        socket.on("reconnect_attempt", (attemptNumber) => {
          log(`üîÑ Reconnection attempt ${attemptNumber}...`, "info");
        });

        // Chat events
        socket.on("userJoined", (data) => {
          log(`üë§ User joined room: ${data.userId}`, "info");
          addSystemMessage(`${data.userId} joined the chat`);
        });

        socket.on("message", (data) => {
          log(`üí¨ Message received: ${data.message}`, "info");
          addMessage(data.message, data.senderId, false, data);
        });

        socket.on("typing", (data) => {
          showTypingIndicator(data.senderId);
        });

        socket.on("error", (data) => {
          log(`‚ùå Error: ${data.message}`, "error");
          addSystemMessage(`Error: ${data.message}`);
        });

        // New message events
        socket.on("messageRead", (data) => {
          log(`üìñ Message read: ${data.messageId} by ${data.readBy}`, "info");
          updateMessageStatus(data.messageId, "read", data.readBy);
        });

        socket.on("messageDelivered", (data) => {
          log(
            `üì¨ Message delivered: ${data.messageId} to ${data.deliveredTo}`,
            "info"
          );
          updateMessageStatus(data.messageId, "delivered", data.deliveredTo);
        });

        socket.on("messageReaction", (data) => {
          log(
            `üòä Reaction added: ${data.reaction.emoji} to message ${data.messageId}`,
            "info"
          );
          addReactionToMessage(data.messageId, data.reaction);
        });

        socket.on("reactionRemoved", (data) => {
          log(
            `üóëÔ∏è Reaction removed from message ${data.messageId} by ${data.userId}`,
            "info"
          );
          removeReactionFromMessage(data.messageId, data.userId);
        });

        socket.on("messageEdited", (data) => {
          log(`‚úèÔ∏è Message edited: ${data.messageId}`, "info");
          updateMessageContent(data.messageId, data.newMessage, data.editedAt);
        });

        socket.on("messageDeleted", (data) => {
          log(
            `üóëÔ∏è Message deleted: ${data.messageId} by ${data.deletedBy}`,
            "info"
          );
          deleteMessageFromUI(data.messageId);
        });

        socket.on("messagesResponse", (data) => {
          log(
            `üìã Loaded ${data.messages.length} messages (${data.total} total)`,
            "info"
          );
          displayMessages(data.messages);
        });
      }

      function disconnect() {
        if (socket) {
          log("Disconnecting...", "info");
          socket.disconnect();
          socket = null;
        }
      }

      function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value.trim();

        if (!message) return;

        if (socket && socket.connected) {
          socket.emit("sendMessage", {
            receiverId: chatPartnerId,
            message: message,
          });

          // Create temporary message data for UI
          const tempMessageData = {
            messageId: Math.random().toString(36).substr(2, 9),
            timestamp: new Date().toISOString(),
            messageType: "text",
            status: "sending",
          };

          addMessage(message, "You", true, tempMessageData);
          messageInput.value = "";
          log(`üí¨ Sent message: ${message}`, "info");
        } else {
          log("Not connected to server!", "error");
        }
      }

      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        } else {
          // Send typing indicator
          if (socket && socket.connected) {
            socket.emit("typing", { receiverId: chatPartnerId });

            // Clear previous timeout
            if (typingTimeout) {
              clearTimeout(typingTimeout);
            }

            // Hide typing indicator after 3 seconds
            typingTimeout = setTimeout(() => {
              hideTypingIndicator();
            }, 3000);
          }
        }
      }

      function addMessage(text, sender, isSent, messageData = null) {
        const chatMessages = document.getElementById("chatMessages");

        // Remove "Start typing..." message if it exists
        const startMessage = chatMessages.querySelector(
          'div[style*="text-align: center"]'
        );
        if (startMessage) {
          startMessage.remove();
        }

        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${isSent ? "sent" : "received"}`;

        if (messageData) {
          messageDiv.setAttribute("data-message-id", messageData.messageId);
        }

        const messageId = messageData
          ? messageData.messageId
          : Math.random().toString(36).substr(2, 9);
        const timestamp = messageData
          ? new Date(messageData.timestamp).toLocaleTimeString()
          : new Date().toLocaleTimeString();

        // Handle different message types
        let contentHTML = "";
        if (messageData && messageData.messageType !== "text") {
          contentHTML = getMessageContentHTML(text, messageData);
        } else {
          contentHTML = `<div class="message-content">${text}</div>`;
        }

        messageDiv.innerHTML = `
          ${contentHTML}
          <div class="message-info">
            ${sender} ‚Ä¢ ${timestamp}
            ${
              messageData
                ? `<br><small class="message-status" style="color: #666;">ID: ${messageId} ‚Ä¢ Type: ${
                    messageData.messageType || "text"
                  }</small>`
                : ""
            }
          </div>
        `;

        // Make message clickable to select for actions
        messageDiv.style.cursor = "pointer";
        messageDiv.onclick = () => {
          selectedMessageId = messageId;
          document.getElementById("messageIdInput").value = messageId;
          log(`Selected message: ${messageId}`, "info");
        };

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function addSystemMessage(text) {
        const chatMessages = document.getElementById("chatMessages");

        const messageDiv = document.createElement("div");
        messageDiv.style.cssText =
          "text-align: center; color: #666; font-style: italic; margin: 10px 0; font-size: 14px;";
        messageDiv.textContent = text;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function getMessageContentHTML(text, messageData) {
        const messageType = messageData.messageType;
        const metadata = messageData.metadata || {};

        switch (messageType) {
          case "image":
            return `
              <div class="message-content">
                <div style="margin-bottom: 5px;">${text}</div>
                ${
                  metadata.fileUrl
                    ? `<img src="${metadata.fileUrl}" style="max-width: 200px; max-height: 150px; border-radius: 5px; cursor: pointer;" onclick="openImageModal('${metadata.fileUrl}')">`
                    : ""
                }
                ${
                  metadata.fileName
                    ? `<div style="font-size: 12px; color: #666; margin-top: 5px;">üìé ${metadata.fileName}</div>`
                    : ""
                }
              </div>
            `;

          case "audio":
            return `
              <div class="message-content">
                <div style="margin-bottom: 5px;">${text}</div>
                ${
                  metadata.fileUrl
                    ? `<audio controls style="width: 100%; max-width: 300px;"><source src="${
                        metadata.fileUrl
                      }" type="${metadata.mimeType || "audio/mpeg"}"></audio>`
                    : ""
                }
                ${
                  metadata.fileName
                    ? `<div style="font-size: 12px; color: #666; margin-top: 5px;">üéµ ${metadata.fileName}</div>`
                    : ""
                }
              </div>
            `;

          case "video":
            return `
              <div class="message-content">
                <div style="margin-bottom: 5px;">${text}</div>
                ${
                  metadata.fileUrl
                    ? `<video controls style="max-width: 200px; max-height: 150px;"><source src="${
                        metadata.fileUrl
                      }" type="${metadata.mimeType || "video/mp4"}"></video>`
                    : ""
                }
                ${
                  metadata.fileName
                    ? `<div style="font-size: 12px; color: #666; margin-top: 5px;">üé¨ ${metadata.fileName}</div>`
                    : ""
                }
              </div>
            `;

          case "file":
            return `
              <div class="message-content">
                <div style="margin-bottom: 5px;">${text}</div>
                <div style="padding: 10px; background-color: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                  <div style="font-size: 14px; font-weight: bold;">üìÑ ${
                    metadata.fileName || "Unknown File"
                  }</div>
                  <div style="font-size: 12px; color: #666;">Size: ${
                    metadata.fileSize
                      ? (metadata.fileSize / 1024 / 1024).toFixed(2) + " MB"
                      : "Unknown"
                  }</div>
                  <div style="font-size: 12px; color: #666;">Type: ${
                    metadata.mimeType || "Unknown"
                  }</div>
                </div>
              </div>
            `;

          default:
            return `<div class="message-content">${text}</div>`;
        }
      }

      function openImageModal(imageUrl) {
        // Create modal for full-size image viewing
        const modal = document.createElement("div");
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          cursor: pointer;
        `;

        const img = document.createElement("img");
        img.src = imageUrl;
        img.style.cssText = `
          max-width: 90%;
          max-height: 90%;
          border-radius: 5px;
        `;

        modal.appendChild(img);
        modal.onclick = () => document.body.removeChild(modal);
        document.body.appendChild(modal);
      }

      function showTypingIndicator(senderId) {
        const typingIndicator = document.getElementById("typingIndicator");
        const typingText = document.getElementById("typingText");

        typingText.innerHTML = `${senderId} is typing<span class="typing-dots">...</span>`;
        typingIndicator.style.display = "block";

        // Auto-hide after 3 seconds
        setTimeout(() => {
          hideTypingIndicator();
        }, 3000);
      }

      function hideTypingIndicator() {
        const typingIndicator = document.getElementById("typingIndicator");
        typingIndicator.style.display = "none";
      }

      // New message action functions
      function loadMessages() {
        if (socket && socket.connected && currentChatId) {
          socket.emit("getMessages", {
            chatId: currentChatId,
            page: 1,
            limit: 50,
          });
          log("üìã Loading messages...", "info");
        } else {
          log("Not connected or no chat selected!", "error");
        }
      }

      function addReaction() {
        const messageId = document.getElementById("messageIdInput").value;
        const emoji = document.getElementById("emojiInput").value;

        if (!messageId) {
          log("Please enter a message ID", "error");
          return;
        }

        if (socket && socket.connected) {
          socket.emit("addReaction", { messageId, emoji });
          log(`üòä Adding reaction ${emoji} to message ${messageId}`, "info");
        } else {
          log("Not connected to server!", "error");
        }
      }

      function editMessage() {
        const messageId = document.getElementById("messageIdInput").value;
        const newMessage = prompt("Enter new message:", "");

        if (!messageId || !newMessage) return;

        if (socket && socket.connected) {
          socket.emit("editMessage", { messageId, newMessage });
          log(`‚úèÔ∏è Editing message ${messageId}`, "info");
        } else {
          log("Not connected to server!", "error");
        }
      }

      function deleteMessage() {
        const messageId = document.getElementById("messageIdInput").value;

        if (!messageId) {
          log("Please enter a message ID", "error");
          return;
        }

        if (confirm("Are you sure you want to delete this message?")) {
          if (socket && socket.connected) {
            socket.emit("deleteMessage", { messageId });
            log(`üóëÔ∏è Deleting message ${messageId}`, "info");
          } else {
            log("Not connected to server!", "error");
          }
        }
      }

      function markAsRead() {
        const messageId = document.getElementById("messageIdInput").value;

        if (!messageId) {
          log("Please enter a message ID", "error");
          return;
        }

        if (socket && socket.connected) {
          socket.emit("markAsRead", { messageId });
          log(`üìñ Marking message ${messageId} as read`, "info");
        } else {
          log("Not connected to server!", "error");
        }
      }

      // UI update functions
      function updateMessageStatus(messageId, status, userId) {
        const messageElement = document.querySelector(
          `[data-message-id="${messageId}"]`
        );
        if (messageElement) {
          const statusElement = messageElement.querySelector(".message-status");
          if (statusElement) {
            statusElement.textContent = `${status} by ${userId}`;
            statusElement.style.color =
              status === "read" ? "#28a745" : "#007bff";
          }
        }
      }

      function addReactionToMessage(messageId, reaction) {
        const messageElement = document.querySelector(
          `[data-message-id="${messageId}"]`
        );
        if (messageElement) {
          let reactionsContainer = messageElement.querySelector(".reactions");
          if (!reactionsContainer) {
            reactionsContainer = document.createElement("div");
            reactionsContainer.className = "reactions";
            reactionsContainer.style.cssText =
              "margin-top: 5px; font-size: 12px;";
            messageElement.appendChild(reactionsContainer);
          }

          const reactionElement = document.createElement("span");
          reactionElement.textContent = reaction.emoji;
          reactionElement.style.cssText = "margin-right: 5px; cursor: pointer;";
          reactionElement.title = `Reacted by ${reaction.userId}`;
          reactionsContainer.appendChild(reactionElement);
        }
      }

      function removeReactionFromMessage(messageId, userId) {
        const messageElement = document.querySelector(
          `[data-message-id="${messageId}"]`
        );
        if (messageElement) {
          const reactionsContainer = messageElement.querySelector(".reactions");
          if (reactionsContainer) {
            // Simple implementation - remove all reactions
            reactionsContainer.innerHTML = "";
          }
        }
      }

      function updateMessageContent(messageId, newContent, editedAt) {
        const messageElement = document.querySelector(
          `[data-message-id="${messageId}"]`
        );
        if (messageElement) {
          const contentElement =
            messageElement.querySelector(".message-content");
          if (contentElement) {
            contentElement.textContent = newContent;
          }

          const infoElement = messageElement.querySelector(".message-info");
          if (infoElement) {
            infoElement.innerHTML += ` ‚Ä¢ Edited at ${new Date(
              editedAt
            ).toLocaleTimeString()}`;
          }
        }
      }

      function deleteMessageFromUI(messageId) {
        const messageElement = document.querySelector(
          `[data-message-id="${messageId}"]`
        );
        if (messageElement) {
          messageElement.style.opacity = "0.5";
          messageElement.style.textDecoration = "line-through";
          const contentElement =
            messageElement.querySelector(".message-content");
          if (contentElement) {
            contentElement.textContent = "This message was deleted";
          }
        }
      }

      function displayMessages(messages) {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML = "";

        messages.forEach((msg) => {
          addMessage(
            msg.message,
            msg.senderId,
            msg.senderId === currentUserId,
            msg
          );
        });
      }

      // File handling functions
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        selectedFile = file;
        showFilePreview(file);
        document.getElementById("sendFileBtn").disabled = false;
        document.getElementById("clearFileBtn").disabled = false;
        log(
          `üìÅ File selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(
            2
          )} MB)`,
          "info"
        );
      }

      function showFilePreview(file) {
        const preview = document.getElementById("filePreview");
        const content = document.getElementById("previewContent");

        preview.style.display = "block";

        const fileType = file.type.split("/")[0];
        let previewHTML = `<strong>File:</strong> ${file.name}<br>`;
        previewHTML += `<strong>Size:</strong> ${(
          file.size /
          1024 /
          1024
        ).toFixed(2)} MB<br>`;
        previewHTML += `<strong>Type:</strong> ${file.type}<br>`;

        if (fileType === "image") {
          const reader = new FileReader();
          reader.onload = function (e) {
            previewHTML += `<br><img src="${e.target.result}" style="max-width: 200px; max-height: 150px; border-radius: 5px;">`;
            content.innerHTML = previewHTML;
          };
          reader.readAsDataURL(file);
        } else if (fileType === "audio") {
          previewHTML += `<br><audio controls style="width: 100%;"><source src="${URL.createObjectURL(
            file
          )}" type="${file.type}"></audio>`;
          content.innerHTML = previewHTML;
        } else if (fileType === "video") {
          previewHTML += `<br><video controls style="max-width: 200px; max-height: 150px;"><source src="${URL.createObjectURL(
            file
          )}" type="${file.type}"></video>`;
          content.innerHTML = previewHTML;
        } else {
          previewHTML += `<br><span style="color: #666;">üìÑ File preview not available</span>`;
          content.innerHTML = previewHTML;
        }
      }

      function clearFile() {
        selectedFile = null;
        document.getElementById("fileInput").value = "";
        document.getElementById("filePreview").style.display = "none";
        document.getElementById("sendFileBtn").disabled = true;
        document.getElementById("clearFileBtn").disabled = true;
        log("üóëÔ∏è File cleared", "info");
      }

      function sendFile() {
        if (!selectedFile || !socket || !socket.connected) {
          log("No file selected or not connected!", "error");
          return;
        }

        const fileType = selectedFile.type.split("/")[0];
        let messageType = "file";

        if (fileType === "image") messageType = "image";
        else if (fileType === "audio") messageType = "audio";
        else if (fileType === "video") messageType = "video";

        // Convert file to base64 for transmission
        const reader = new FileReader();
        reader.onload = function (e) {
          const base64Data = e.target.result;

          // Create message data for file
          const fileMessageData = {
            messageId: Math.random().toString(36).substr(2, 9),
            timestamp: new Date().toISOString(),
            messageType: messageType,
            status: "sending",
            metadata: {
              fileName: selectedFile.name,
              fileSize: selectedFile.size,
              mimeType: selectedFile.type,
              fileUrl: base64Data, // In real app, this would be uploaded to S3
            },
          };

          // Send file message
          socket.emit("sendMessage", {
            receiverId: chatPartnerId,
            message: `üìé ${selectedFile.name}`,
            messageType: messageType,
            metadata: fileMessageData.metadata,
          });

          // Add to UI
          addMessage(`üìé ${selectedFile.name}`, "You", true, fileMessageData);

          log(`üì§ Sending file: ${selectedFile.name}`, "info");

          // Clear file after sending
          clearFile();
        };

        reader.readAsDataURL(selectedFile);
      }

      function clearChat() {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML = `
          <div style="text-align: center; color: #666; font-style: italic;">
            Start typing to begin the conversation...
          </div>
        `;
        log("Chat cleared", "info");
      }

      function toggleReconnection() {
        autoReconnect = !autoReconnect;
        const btn = document.getElementById("reconnectBtn");
        btn.textContent = autoReconnect
          ? "Disable Auto-Reconnect"
          : "Enable Auto-Reconnect";
        log(
          `Auto-reconnection ${autoReconnect ? "enabled" : "disabled"}`,
          "info"
        );

        if (socket) {
          socket.io.reconnection(autoReconnect);
          socket.io.reconnectionAttempts(autoReconnect ? 3 : 0);
        }
      }

      // Auto-connect on page load (optional)
      window.addEventListener("load", () => {
        log("Socket.IO Test Page Loaded", "info");
        log('Click "Connect" to establish connection', "info");
      });

      // Handle page unload
      window.addEventListener("beforeunload", () => {
        if (socket) {
          socket.disconnect();
        }
      });
    </script>
  </body>
</html>
